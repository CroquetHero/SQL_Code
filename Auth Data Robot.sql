        select COMPLETE_BOOL,      DIVISION_ID,     MERCHANT_NUMBER,  BANK_NAME,   MERCHANT_DESCRIPTOR,                PAYMENT_METHOD_ID,              TRANSACTION_CURRENCY,        USD,      BILLING_COUNTRY_ID,                PAYMENT_PROCESSOR_NAME,                DAY_OF_WEEK,                DAY_OF_MONTH,           HOUR_OF_DAY,                LOCAL_DAY_OF_WEEK,                LOCAL_DAY_OF_MONTH,           LOCAL_HOUR_OF_DAY,RESPONSE_CODE,                RESPONSE_MESSAGE,   NUMBER_ATTEMPT_PER_TOKEN,           RETRY_ATTEMPT,                NUMBER_OF_SUBMITS,              PROCESSOR_BANK,        PROCESSOR_COUNTRY,                TOKEN_AGE
from(
select complete_bool,at1,division_id, merchant_number,bank_name, merchant_descriptor, payment_method_id,transaction_currency,usd,billing_country_id,
payment_processor_name,day_of_week,day_of_month,hour_of_day,response_code,response_message,number_attempt_per_token,retry_attempt,number_of_submits,processor_bank,processor_country, local_day_of_week,local_day_of_month,local_hour_of_day,ran
, (case when nvl(round((Cpg_Creation_Date - (select min(settlement_date) from rcn_payment_transaction rpt where at1 = rpt.account_token and merchant_descriptor = rpt.merchant_descriptor and transaction_type = 'Settle' )),0),0) < 1 then 0 else nvl(round((Cpg_Creation_Date - (select min(settlement_date) from rcn_payment_transaction rpt where at1 = rpt.account_token and merchant_descriptor = rpt.merchant_descriptor and transaction_type = 'Settle' )),0),0) end)token_age
From (select complete_bool,Division_Id, at1,Merchant_Number, Cpg_Creation_Date, Bank_Name, Merchant_Descriptor, Payment_Method_Id, Transaction_Currency, Usd, Billing_Country_Id, Payment_Processor_Name, Day_Of_Week,Day_Of_Month, Hour_Of_Day,Response_Code, Response_Message,Number_Attempt_Per_Token,Retry_Attempt,Number_Of_Submits,processor_bank,processor_country,country_currency
, To_Char(local_time,'D')local_Day_Of_Week, To_Char(local_time,'DD')local_Day_Of_Month, To_Char(local_time,'HH24')local_Hour_Of_Day
,dbms_random.value(0,1)ran
from (
Select decode(Status,'Completed',1,0)complete_bool,at1,Division_Id, Merchant_Number, Bank_Name, Merchant_Descriptor, Payment_Method_Id, Transaction_Currency, Usd, Billing_Country_Id, Payment_Processor_Name, Day_Of_Week,Day_Of_Month, Hour_Of_Day,Response_Code, Response_Message,Number_Attempt_Per_Token,Retry_Attempt,Number_Of_Submits
, payment_processor_name||':'||bank_name processor_bank
, payment_processor_name||':'||Billing_Country_Id processor_country
,billing_country_id||':'||transaction_currency country_currency
,cpg_creation_date
,decode(billing_country_id,'AF' , '0','AL' , '-1','DZ' , '0','AS' , '0','AD' , '-1','AO' , '-1','AI' , '4','AG' , '4','AR' , '3','AM' , '-4','AW' , '4','SH' , '0','AU' , '-10','AT' , '-1','AZ' , '-4','BS' , '5','BH' , '-3','BD' , '-6','BB' , '4','BY' , '-3','BE' , '-1','BZ' , '6','BJ' , '-1','BM' , '4','BT' , '-5','BO' , '4','BQ' , '0','BA' , '-1','BW' , '-2','BR' , '3','VG' , '0','BN' , '-8','BG' , '-2','BF' , '0','BI' , '-2','KH' , '-7','CM' , '-1','CA' , '4','CV' , '1','KY' , '5','CF' , '0','TD' , '0','NZ' , '-12','CL' , '4','CN' , '-8','CX' , '0','CC' , '0','CO' , '4','KM' , '0','CG' , '-1','CK' , '10','CR' , '6','HR' , '-1','CU' , '3','CW' , '4','CY' , '-2','CZ' , '-1','CD' , '0','DK' , '-1','IO' , '-5','DJ' , '-3','DM' , '0','DO' , '4','TL' , '0','EC' , '5','EG' , '-2','SV' , '6','GQ' , '-1','ER' , '-3','EE' , '-3','ET' , '-3','FK' , '4','FO' , '0','FM' , '0','FJ' , '-12','FI' , '-2','FR' , '-1','GF' , '4','PF' , '10','GA' , '0','GM' , '0','GE' , '-4','DE' , '-1','GH' , '0','GI' , '-1','GR' , '-2','GL' , '3','GD' , '0','GP' , '4','GU' , '-10','GT' , '6','GY' , '0','GN' , '0','GW' , '0','GY' , '3','HT' , '5','HN' , '6','HK' , '-8','HU' , '-1','IS' , '0','IN' , '-5','ID' , '-9','IR' , '-3','IQ' , '-3','IE' , '0','IM' , '0','IL' , '-2','IT' , '-1','CI' , '0','JM' , '5','JP' , '-9','JO' , '-2','KZ' , '-6','KE' , '-3','KI' , '-12','RS' , '-1','KW' , '-3','KG' , '-6','LA' , '-7','LV' , '-3','LB' , '-2','LS' , '-2','LR' , '0','LY' , '-2','LI' , '-1','LT' , '-2','LU' , '-1','MO' , '-8','MK' , '0','MG' , '-3','MW' , '-2','MY' , '-8','MV' , '0','ML' , '0','MT' , '-1','MP' , '-10','MH' , '-10','MQ' , '4','MR' , '0','MU' , '-4','YT' , '0','MX' , '6','UM' , '0','PM' , '0','MD' , '-3','MC' , '-1','MN' , '-8','ME' , '0','MS' , '4','MA' , '0','MZ' , '-2','MM' , '0','NA' , '-2','NR' , '-12','NP' , '-5','NL' , '-1','CW' , '4','KN' , '0','NC' , '-11','NZ' , '-12','NI' , '6','NE' , '0','NG' , '-1','NU' , '0','NF' , '-11','KP' , '0','NO' , '-1','OM' , '-4','PK' , '-5','PW' , '-9','PS' , '-2','PA' , '5','PG' , '-10','PY' , '4','PE' , '5','PH' , '-8','PL' , '-1','PT' , '-1','ST' , '0','PR' , '4','QA' , '-3','RE' , '-4','RO' , '-2','RU' , '-3','RW' , '-2','SA' , '4','MP' , '0','WS' , '0','SM' , '-1','ST' , '0','SA' , '-3','SN' , '0','RS' , '-1','SC' , '-4','SL' , '0','SG' , '-8','SE' , '-1','SX' , '0','SK' , '-3','SI' , '-1','SB' , '-11','SO' , '0','ZA' , '-2','KR' , '-9','SS' , '0','ES' , '-1','LK' , '-5','SH' , '0','KN' , '0','LC' , '0','PM' , '0','VC' , '0','SD' , '-2','SR' , '0','SZ' , '-2','SE' , '-1','CH' , '-1','SY' , '-2','TW' , '-8','TJ' , '-6','TZ' , '-3','TH' , '-7','TG' , '0','TK' , '0','TO' , '-13','TT' , '4','TN' , '-1','TR' , '-2','TM' , '-5','TC' , '0','TV' , '-12','UG' , '-3','UA' , '-3','AE' , '-4','GB' , '0','US' , '0','UY' , '3','VI' , '4','UZ' , '-6','VU' , '-11','VA' , '0','VE' , '4','VN' , '-7','UM' , '0','WF' , '0','YE' , '0','RS' , '-1','CD' , '0','ZM' , '-2','TZ' , '0','ZW' , '-2','AN' , '0','AQ' , '0','AX' , '0','BL' , '0','BV' , '0','C2' , '0','CS' , '0','EH' , '0','FX' , '0','GG' , '0','GS' , '0','HM' , '0','IB' , '0','IC' , '0','JE' , '0','MF' , '0','PN' , '0','QC' , '0','QU' , '0','SF' , '0','SJ' , '0','TF' , '0','TP' , '0','UK' , '0','YU' , '0','ZZ' , '0')ofset
,(cpg_creation_date + ((decode(billing_country_id,'AF' , '0','AL' , '-1','DZ' , '0','AS' , '0','AD' , '-1','AO' , '-1','AI' , '4','AG' , '4','AR' , '3','AM' , '-4','AW' , '4','SH' , '0','AU' , '-10','AT' , '-1','AZ' , '-4','BS' , '5','BH' , '-3','BD' , '-6','BB' , '4','BY' , '-3','BE' , '-1','BZ' , '6','BJ' , '-1','BM' , '4','BT' , '-5','BO' , '4','BQ' , '0','BA' , '-1','BW' , '-2','BR' , '3','VG' , '0','BN' , '-8','BG' , '-2','BF' , '0','BI' , '-2','KH' , '-7','CM' , '-1','CA' , '4','CV' , '1','KY' , '5','CF' , '0','TD' , '0','NZ' , '-12','CL' , '4','CN' , '-8','CX' , '0','CC' , '0','CO' , '4','KM' , '0','CG' , '-1','CK' , '10','CR' , '6','HR' , '-1','CU' , '3','CW' , '4','CY' , '-2','CZ' , '-1','CD' , '0','DK' , '-1','IO' , '-5','DJ' , '-3','DM' , '0','DO' , '4','TL' , '0','EC' , '5','EG' , '-2','SV' , '6','GQ' , '-1','ER' , '-3','EE' , '-3','ET' , '-3','FK' , '4','FO' , '0','FM' , '0','FJ' , '-12','FI' , '-2','FR' , '-1','GF' , '4','PF' , '10','GA' , '0','GM' , '0','GE' , '-4','DE' , '-1','GH' , '0','GI' , '-1','GR' , '-2','GL' , '3','GD' , '0','GP' , '4','GU' , '-10','GT' , '6','GY' , '0','GN' , '0','GW' , '0','GY' , '3','HT' , '5','HN' , '6','HK' , '-8','HU' , '-1','IS' , '0','IN' , '-5','ID' , '-9','IR' , '-3','IQ' , '-3','IE' , '0','IM' , '0','IL' , '-2','IT' , '-1','CI' , '0','JM' , '5','JP' , '-9','JO' , '-2','KZ' , '-6','KE' , '-3','KI' , '-12','RS' , '-1','KW' , '-3','KG' , '-6','LA' , '-7','LV' , '-3','LB' , '-2','LS' , '-2','LR' , '0','LY' , '-2','LI' , '-1','LT' , '-2','LU' , '-1','MO' , '-8','MK' , '0','MG' , '-3','MW' , '-2','MY' , '-8','MV' , '0','ML' , '0','MT' , '-1','MP' , '-10','MH' , '-10','MQ' , '4','MR' , '0','MU' , '-4','YT' , '0','MX' , '6','UM' , '0','PM' , '0','MD' , '-3','MC' , '-1','MN' , '-8','ME' , '0','MS' , '4','MA' , '0','MZ' , '-2','MM' , '0','NA' , '-2','NR' , '-12','NP' , '-5','NL' , '-1','CW' , '4','KN' , '0','NC' , '-11','NZ' , '-12','NI' , '6','NE' , '0','NG' , '-1','NU' , '0','NF' , '-11','KP' , '0','NO' , '-1','OM' , '-4','PK' , '-5','PW' , '-9','PS' , '-2','PA' , '5','PG' , '-10','PY' , '4','PE' , '5','PH' , '-8','PL' , '-1','PT' , '-1','ST' , '0','PR' , '4','QA' , '-3','RE' , '-4','RO' , '-2','RU' , '-3','RW' , '-2','SA' , '4','MP' , '0','WS' , '0','SM' , '-1','ST' , '0','SA' , '-3','SN' , '0','RS' , '-1','SC' , '-4','SL' , '0','SG' , '-8','SE' , '-1','SX' , '0','SK' , '-3','SI' , '-1','SB' , '-11','SO' , '0','ZA' , '-2','KR' , '-9','SS' , '0','ES' , '-1','LK' , '-5','SH' , '0','KN' , '0','LC' , '0','PM' , '0','VC' , '0','SD' , '-2','SR' , '0','SZ' , '-2','SE' , '-1','CH' , '-1','SY' , '-2','TW' , '-8','TJ' , '-6','TZ' , '-3','TH' , '-7','TG' , '0','TK' , '0','TO' , '-13','TT' , '4','TN' , '-1','TR' , '-2','TM' , '-5','TC' , '0','TV' , '-12','UG' , '-3','UA' , '-3','AE' , '-4','GB' , '0','US' , '0','UY' , '3','VI' , '4','UZ' , '-6','VU' , '-11','VA' , '0','VE' , '4','VN' , '-7','UM' , '0','WF' , '0','YE' , '0','RS' , '-1','CD' , '0','ZM' , '-2','TZ' , '0','ZW' , '-2','AN' , '0','AQ' , '0','AX' , '0','BL' , '0','BV' , '0','C2' , '0','CS' , '0','EH' , '0','FX' , '0','GG' , '0','GS' , '0','HM' , '0','IB' , '0','IC' , '0','JE' , '0','MF' , '0','PN' , '0','QC' , '0','QU' , '0','SF' , '0','SJ' , '0','TF' , '0','TP' , '0','UK' , '0','YU' , '0','ZZ' , '0'))/24))local_time
From (
Select  Division_Id, Merchant_Number,Division_Order_Id, Bank_Name, account_token at1, Merchant_Descriptor, Payment_Method_Id, Auth_Amount,Transaction_Currency,Round(Decode(Transaction_Currency, 'USD', Auth_Amount, (Auth_Amount/(Select Der.Exchange_Rate_Num From Currency_Exchange_Sfact_Vw Der Where Trunc(Cpg_Creation_Date) = Der.Effective_Date And  Transaction_Currency = Der.To_Currency_Code And Rownum < 2))),2) As Usd,  Billing_Country_Id, Payment_Processor_Name, Status, Account_Token, Recurring_Flag, Cpg_Creation_Date
, To_Char(Cpg_Creation_Date,'D')Day_Of_Week, To_Char(Cpg_Creation_Date,'DD')Day_Of_Month, To_Char(Cpg_Creation_Date,'HH24')Hour_Of_Day,
Response_Code,Response_Message
,Rank() Over (Partition By Account_Token Order By Cpg_Creation_Date)Number_Attempt_Per_Token ,Rank() Over (Partition By Division_Order_Id,Account_Token,Rank1 Order By Cpg_Creation_Date)Retry_Attempt, Rank1 Number_Of_Submits
From 

(

Select Division_Id, Merchant_Number,Division_Order_Id, Bank_Name, Merchant_Descriptor, Payment_Method_Id, Payment_Processor_Name, Status,Auth_Amount,Transaction_Currency,  Billing_Country_Id, Account_Token, Recurring_Flag, Cpg_Creation_Date, Response_Code,Response_Message , Rank() Over (Partition By Account_Token,Division_Order_Id Order By Cpg_Creation_Date)Rank , Rank() Over (Partition By Division_Order_Id,Account_Token,Payment_Processor_Name Order By Cpg_Creation_Date)Rank1,Notes
From Rcn_Auth_Trans 
Where Settlement_Date Between Sysdate - 30 And Sysdate
and creation_date > sysdate - 30
And Payment_Method_Id In ('Visa','MasterCard') 
--and payment_processor_name in ('netgiro-bms', 'netgiro-seb', 'firstdata', 'mes')
And Recurring_Flag = 'recurring' 
And Division_Id = 'pacific'
And Status <> 'Reversed' 
--and merchant_descriptor = 'DRI*SpyHunter'
--and Billing_Country_Id in ('AT')--,'IT','SA','CA','GB','SE')
--and division_order_id in ('ST12926994','ST12926995','14857617100','15256854700','ST12826591','ST12826592','ST12847344','ST12847345','ST12871037','ST12871038','ST12893442','ST12893443','14963663900','ST12799768','ST12799769','ST12945164','ST13011502','15107148400','13848125000','15429854000','15453358800','ST12902862','13774285700','ST13024196','ST13049606','15209872000','ST12790140','ST12812313','13889108400','15444665600','15419353200','ST12966067','ST12966111','15124206100','15514069900','ST12923845','14986438700','15373470100')

Order By Division_Order_Id, Rank 

)

)

)

where number_of_submits = '1'
and retry_attempt = '1' 

)

--where rownum < 1501 

--order by ran 

)
